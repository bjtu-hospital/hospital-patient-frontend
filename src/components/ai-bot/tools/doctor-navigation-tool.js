/**
 * åŒ»ç”Ÿå¯¼èˆªå·¥å…·
 * 
 * æ ¹æ®ç”¨æˆ·æè¿°çš„ç—‡çŠ¶/ç–¾ç—…ï¼Œæ™ºèƒ½è·³è½¬åˆ°ç§‘å®¤ä¸“å®¶é¡µé¢å¹¶é¢„è®¾ç­›é€‰æ¡ä»¶
 */

// ç—‡çŠ¶/ç–¾ç—… â†’ ç§‘å®¤æ˜ å°„è¡¨
// æ³¨æ„ï¼šç§‘å®¤åè¦èƒ½åŒ¹é…åç«¯è¿”å›çš„ç§‘å®¤åç§°ï¼Œä½¿ç”¨æ¨¡ç³ŠåŒ¹é…å…³é”®è¯
const SYMPTOM_TO_DEPARTMENT = {
  // å¿ƒè¡€ç®¡ç›¸å…³ - ä½¿ç”¨"å¿ƒ"ä½œä¸ºå…³é”®è¯ï¼Œèƒ½åŒ¹é…"å¿ƒè¡€ç®¡å†…ç§‘"ã€"å¿ƒå†…ç§‘"ç­‰
  'å¿ƒè„ç—…': 'å¿ƒ',
  'å¿ƒè„': 'å¿ƒ',
  'å¿ƒè¡€ç®¡': 'å¿ƒ',
  'èƒ¸é—·': 'å¿ƒ',
  'å¿ƒæ‚¸': 'å¿ƒ',
  'å¿ƒç»ç—›': 'å¿ƒ',
  'é«˜è¡€å‹': 'å¿ƒ',
  'å† å¿ƒç—…': 'å¿ƒ',
  'å¿ƒå¾‹ä¸é½': 'å¿ƒ',
  'å¿ƒè‚Œç‚': 'å¿ƒ',
  'å¿ƒåŠ›è¡°ç«­': 'å¿ƒ',
  
  // ç¥ç»ç›¸å…³
  'å¤´ç–¼': 'ç¥ç»',
  'å¤´ç—›': 'ç¥ç»',
  'åå¤´ç—›': 'ç¥ç»',
  'å¤´æ™•': 'ç¥ç»',
  'çœ©æ™•': 'ç¥ç»',
  'å¤±çœ ': 'ç¥ç»',
  'ç™«ç—«': 'ç¥ç»',
  'å¸•é‡‘æ£®': 'ç¥ç»',
  'ä¸­é£': 'ç¥ç»',
  'è„‘æ¢—': 'ç¥ç»',
  'ç¥ç»': 'ç¥ç»',
  
  // æ¶ˆåŒ–ç›¸å…³
  'èƒƒç–¼': 'æ¶ˆåŒ–',
  'èƒƒç—›': 'æ¶ˆåŒ–',
  'è‚šå­ç–¼': 'æ¶ˆåŒ–',
  'è…¹ç—›': 'æ¶ˆåŒ–',
  'èƒƒç‚': 'æ¶ˆåŒ–',
  'èƒƒæºƒç–¡': 'æ¶ˆåŒ–',
  'æ‹‰è‚šå­': 'æ¶ˆåŒ–',
  'è…¹æ³»': 'æ¶ˆåŒ–',
  'ä¾¿ç§˜': 'æ¶ˆåŒ–',
  'æ¶ˆåŒ–ä¸è‰¯': 'æ¶ˆåŒ–',
  'è‚ èƒƒ': 'æ¶ˆåŒ–',
  'è‚ç—…': 'æ¶ˆåŒ–',
  'è‚ç‚': 'æ¶ˆåŒ–',
  
  // å‘¼å¸ç›¸å…³
  'å’³å—½': 'å‘¼å¸',
  'æ„Ÿå†’': 'å‘¼å¸',
  'å‘çƒ§': 'å‘¼å¸',
  'å‘çƒ­': 'å‘¼å¸',
  'å“®å–˜': 'å‘¼å¸',
  'æ°”å–˜': 'å‘¼å¸',
  'è‚ºç‚': 'å‘¼å¸',
  'æ”¯æ°”ç®¡ç‚': 'å‘¼å¸',
  'å‘¼å¸å›°éš¾': 'å‘¼å¸',
  
  // éª¨ç§‘ç›¸å…³
  'éª¨æŠ˜': 'éª¨ç§‘',
  'è…°ç–¼': 'éª¨ç§‘',
  'è…°ç—›': 'éª¨ç§‘',
  'è…°æ¤': 'éª¨ç§‘',
  'é¢ˆæ¤': 'éª¨ç§‘',
  'å…³èŠ‚ç—›': 'éª¨ç§‘',
  'å…³èŠ‚ç‚': 'éª¨ç§‘',
  'éª¨è´¨ç–æ¾': 'éª¨ç§‘',
  'è„ŠæŸ±': 'éª¨ç§‘',
  'è¿åŠ¨æŸä¼¤': 'éª¨ç§‘',
  
  // çš®è‚¤ç›¸å…³
  'çš®è‚¤': 'çš®è‚¤',
  'çš®ç–¹': 'çš®è‚¤',
  'è¿‡æ•': 'çš®è‚¤',
  'æ¹¿ç–¹': 'çš®è‚¤',
  'ç—¤ç–®': 'çš®è‚¤',
  'é’æ˜¥ç—˜': 'çš®è‚¤',
  'è„±å‘': 'çš®è‚¤',
  'è¨éº»ç–¹': 'çš®è‚¤',
  
  // çœ¼ç§‘ç›¸å…³
  'çœ¼ç›': 'çœ¼',
  'è§†åŠ›': 'çœ¼',
  'è¿‘è§†': 'çœ¼',
  'ç™½å†…éšœ': 'çœ¼',
  'é’å…‰çœ¼': 'çœ¼',
  'çœ¼ç›ç–¼': 'çœ¼',
  'çœ¼å¹²': 'çœ¼',
  
  // è€³é¼»å–‰ç›¸å…³
  'è€³æœµ': 'è€³é¼»',
  'è€³é¸£': 'è€³é¼»',
  'å¬åŠ›': 'è€³é¼»',
  'é¼»ç‚': 'è€³é¼»',
  'é¼»å­': 'è€³é¼»',
  'å’½å–‰': 'è€³é¼»',
  'å—“å­ç–¼': 'è€³é¼»',
  'æ‰æ¡ƒä½“': 'è€³é¼»',
  
  // å£è…”ç›¸å…³
  'ç‰™ç–¼': 'å£è…”',
  'ç‰™ç—›': 'å£è…”',
  'ç‰™é½¿': 'å£è…”',
  'å£è…”': 'å£è…”',
  'æ‹”ç‰™': 'å£è…”',
  'è¡¥ç‰™': 'å£è…”',
  
  // å¦‡ç§‘ç›¸å…³
  'å¦‡ç§‘': 'å¦‡',
  'æœˆç»': 'å¦‡',
  'ç—›ç»': 'å¦‡',
  'å¦‡ç§‘ç—…': 'å¦‡',
  
  // å„¿ç§‘ç›¸å…³
  'å„¿ç§‘': 'å„¿',
  'å°å­©': 'å„¿',
  'å­©å­': 'å„¿',
  'å®å®': 'å„¿',
  
  // ç²¾ç¥å¿ƒç†ç›¸å…³
  'æŠ‘éƒ': 'ç²¾ç¥',
  'ç„¦è™‘': 'ç²¾ç¥',
  'å¿ƒç†': 'ç²¾ç¥',
  
  // å†…åˆ†æ³Œç›¸å…³
  'ç³–å°¿ç—…': 'å†…åˆ†æ³Œ',
  'ç”²çŠ¶è…º': 'å†…åˆ†æ³Œ',
  'ç”²äº¢': 'å†…åˆ†æ³Œ',
  'è‚¥èƒ–': 'å†…åˆ†æ³Œ',
  
  // æ³Œå°¿ç›¸å…³
  'è‚¾': 'æ³Œå°¿',
  'è‚¾ç—…': 'è‚¾',
  'å°¿é¢‘': 'æ³Œå°¿',
  'å‰åˆ—è…º': 'æ³Œå°¿',
};

// åŒ»é™¢åç§°æ ‡å‡†åŒ–
const HOSPITAL_ALIASES = {
  'åŒ—åŒ»ä¸‰é™¢': 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢',
  'åŒ—å¤§ä¸‰é™¢': 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢',
  'åŒ—åŒ»ä¸‰é™¢æœ¬éƒ¨': 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢',
  'æœ¬éƒ¨': 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢',
  'æ€»é™¢': 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢',
};

/**
 * æ ¹æ®ç—‡çŠ¶/ç–¾ç—…æè¿°åŒ¹é…ç§‘å®¤
 */
function matchDepartment(symptomOrDisease) {
  const keyword = symptomOrDisease.toLowerCase();
  
  // ç²¾ç¡®åŒ¹é…
  for (const [key, dept] of Object.entries(SYMPTOM_TO_DEPARTMENT)) {
    if (keyword.includes(key)) {
      return dept;
    }
  }
  
  return null;
}

/**
 * æ ‡å‡†åŒ–åŒ»é™¢åç§°
 */
function normalizeHospitalName(name) {
  if (!name) return 'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢';
  
  for (const [alias, fullName] of Object.entries(HOSPITAL_ALIASES)) {
    if (name.includes(alias)) {
      return fullName;
    }
  }
  
  return name;
}

/**
 * å¯¼èˆªåˆ°ç§‘å®¤ä¸“å®¶é¡µé¢
 * 
 * @param {Object} params
 * @param {string} params.symptom - ç—‡çŠ¶æˆ–ç–¾ç—…æè¿°ï¼ˆå¦‚"å¿ƒè„ç—…"ã€"å¤´ç–¼"ï¼‰
 * @param {string} [params.hospital] - åŒ»é™¢åç§°ï¼ˆå¯é€‰ï¼Œé»˜è®¤åŒ—åŒ»ä¸‰é™¢æœ¬éƒ¨ï¼‰
 * @param {string} [params.department] - ç›´æ¥æŒ‡å®šç§‘å®¤åç§°ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆçº§é«˜äºsymptomï¼‰
 * @param {string} [params.doctorLevel] - åŒ»ç”Ÿçº§åˆ«ç­›é€‰ï¼ˆå¦‚"ä¸»ä»»åŒ»å¸ˆ"ã€"ä¸“å®¶"ï¼‰
 */
export async function navigateToDoctors(params) {
  const { symptom, hospital, department, doctorLevel } = params;
  console.log('ğŸ©º navigateToDoctors called with:', params);
  
  // ç¡®å®šç§‘å®¤
  let targetDepartment = department;
  if (!targetDepartment && symptom) {
    targetDepartment = matchDepartment(symptom);
    console.log('ğŸ” Matched department from symptom:', symptom, '->', targetDepartment);
  }
  
  // ç¡®å®šåŒ»é™¢
  const targetHospital = normalizeHospitalName(hospital);
  console.log('ğŸ¥ Target hospital:', targetHospital, 'department:', targetDepartment);
  
  // æ„å»ºURLå‚æ•°
  const urlParams = new URLSearchParams();
  
  if (targetHospital) {
    urlParams.set('hospital', targetHospital);
  }
  if (targetDepartment) {
    urlParams.set('department', targetDepartment);
  }
  if (doctorLevel) {
    urlParams.set('level', doctorLevel);
  }
  if (symptom) {
    urlParams.set('keyword', symptom);
  }
  
  const queryString = urlParams.toString();
  const url = `/pages/features/doctors${queryString ? '?' + queryString : ''}`;
  console.log('ğŸ”— Navigating to URL:', url);
  
  // æ‰§è¡Œè·³è½¬
  uni.navigateTo({
    url: url,
    success: () => {
      console.log('âœ… Navigation successful');
    },
    fail: (err) => {
      console.error('âŒ Navigation failed:', err);
      // å°è¯•ä¸å¸¦å‚æ•°è·³è½¬
      uni.navigateTo({ url: '/pages/features/doctors' });
    }
  });
  
  // æ„å»ºè¿”å›ä¿¡æ¯
  let message = 'æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°ç§‘å®¤ä¸“å®¶é¡µé¢';
  
  if (targetDepartment) {
    message = `æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°${targetHospital}çš„${targetDepartment}ï¼Œæ‚¨å¯ä»¥åœ¨é‚£é‡ŒæŸ¥çœ‹ç›¸å…³ä¸“å®¶çš„è¯¦ç»†ç®€å†`;
  } else if (symptom) {
    message = `æ­£åœ¨ä¸ºæ‚¨è·³è½¬åˆ°ç§‘å®¤ä¸“å®¶é¡µé¢ï¼Œå»ºè®®æ‚¨æ ¹æ®"${symptom}"ç›¸å…³ç—‡çŠ¶é€‰æ‹©åˆé€‚çš„ç§‘å®¤`;
  }
  
  if (doctorLevel && doctorLevel.includes('ä¸“å®¶') || doctorLevel?.includes('ä¸»ä»»')) {
    message += 'ï¼Œå·²ä¸ºæ‚¨ç­›é€‰é«˜çº§åˆ«ä¸“å®¶';
  }
  
  return JSON.stringify({
    success: true,
    message: message,
    navigatedTo: url,
    matchedDepartment: targetDepartment,
    hospital: targetHospital
  });
}

/**
 * DeepSeek Tool å®šä¹‰
 */
export const NAVIGATE_TO_DOCTORS_TOOL = {
  type: "function",
  function: {
    name: "navigateToDoctors",
    description: `è·³è½¬åˆ°ç§‘å®¤ä¸“å®¶é¡µé¢ï¼ŒæŸ¥çœ‹åŒ»ç”Ÿç®€å†å’Œè¯¦ç»†ä¿¡æ¯ã€‚å½“ç”¨æˆ·æƒ³è¦ï¼š
1. æŸ¥çœ‹æŸä¸ªç§‘å®¤çš„åŒ»ç”Ÿåˆ—è¡¨
2. æ ¹æ®ç—‡çŠ¶/ç–¾ç—…æ‰¾å¯¹åº”ç§‘å®¤çš„ä¸“å®¶
3. æŸ¥çœ‹åŒ»ç”Ÿçš„ç®€å†ã€ä»‹ç»ã€ä¸“é•¿
4. æ‰¾"å‰å®³çš„"ã€"å¥½çš„"ã€"ä¸“å®¶çº§"åŒ»ç”Ÿ

ä½¿ç”¨æ­¤å·¥å…·å¯ä»¥ç›´æ¥è·³è½¬åˆ°ç§‘å®¤ä¸“å®¶é¡µé¢ï¼Œå¹¶è‡ªåŠ¨åŒ¹é…ç›¸å…³ç§‘å®¤ã€‚

æ”¯æŒçš„ç—‡çŠ¶/ç–¾ç—…åˆ°ç§‘å®¤æ˜ å°„ç¤ºä¾‹ï¼š
- å¿ƒè„ç—…/å¿ƒè¡€ç®¡/èƒ¸é—·/å¿ƒæ‚¸ â†’ å¿ƒè¡€ç®¡å†…ç§‘
- å¤´ç–¼/å¤´æ™•/å¤±çœ  â†’ ç¥ç»å†…ç§‘
- èƒƒç–¼/è‚šå­ç–¼/è…¹æ³» â†’ æ¶ˆåŒ–å†…ç§‘
- å’³å—½/æ„Ÿå†’/å‘çƒ§ â†’ å‘¼å¸å†…ç§‘
- éª¨æŠ˜/è…°ç–¼/é¢ˆæ¤ â†’ éª¨ç§‘
- çš®ç–¹/è¿‡æ•/æ¹¿ç–¹ â†’ çš®è‚¤ç§‘`,
    parameters: {
      type: "object",
      properties: {
        symptom: {
          type: "string",
          description: "ç—‡çŠ¶æˆ–ç–¾ç—…æè¿°ï¼Œå¦‚'å¿ƒè„ç—…'ã€'å¤´ç–¼'ã€'èƒƒç—›'ç­‰ã€‚å·¥å…·ä¼šè‡ªåŠ¨åŒ¹é…å¯¹åº”ç§‘å®¤ã€‚"
        },
        hospital: {
          type: "string",
          description: "åŒ»é™¢åç§°ï¼Œå¦‚'åŒ—åŒ»ä¸‰é™¢'ã€'åŒ—äº¬å¤§å­¦ç¬¬ä¸‰åŒ»é™¢'ã€‚é»˜è®¤ä¸ºåŒ—åŒ»ä¸‰é™¢æœ¬éƒ¨ã€‚"
        },
        department: {
          type: "string",
          description: "ç›´æ¥æŒ‡å®šç§‘å®¤åç§°ï¼Œå¦‚'å¿ƒè¡€ç®¡å†…ç§‘'ã€'ç¥ç»å†…ç§‘'ã€‚å¦‚æœåŒæ—¶æä¾›symptomï¼Œä¼˜å…ˆä½¿ç”¨departmentã€‚"
        },
        doctorLevel: {
          type: "string",
          description: "åŒ»ç”Ÿçº§åˆ«ç­›é€‰ï¼Œå¦‚'ä¸»ä»»åŒ»å¸ˆ'ã€'ä¸“å®¶'ã€'å‰¯ä¸»ä»»åŒ»å¸ˆ'ã€‚ç”¨äºç­›é€‰é«˜çº§åˆ«åŒ»ç”Ÿã€‚"
        }
      },
      required: []
    }
  }
};

export default {
  navigateToDoctors,
  NAVIGATE_TO_DOCTORS_TOOL
};
