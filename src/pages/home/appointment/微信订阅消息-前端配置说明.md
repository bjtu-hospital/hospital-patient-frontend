# 微信订阅消息配置指南

## 一、模板ID配置说明

在 `src/utils/subscribe.js` 文件中，需要将模板ID替换为实际申请的模板ID。

### 当前配置位置

```javascript
export const SUBSCRIBE_TEMPLATE_IDS = {
  // 预约成功通知
  APPOINTMENT_SUCCESS: 'YOUR_TEMPLATE_ID_1',  // ⬅️ 需要替换
  
  // 就诊提醒通知
  APPOINTMENT_REMINDER: 'YOUR_TEMPLATE_ID_2',  // ⬅️ 需要替换
  
  // 候补成功通知
  WAITLIST_SUCCESS: 'YOUR_TEMPLATE_ID_3',  // ⬅️ 需要替换
  
  // 候补转预约通知
  WAITLIST_TO_APPOINTMENT: 'YOUR_TEMPLATE_ID_4',  // ⬅️ 需要替换
  
  // 改约成功通知
  RESCHEDULE_SUCCESS: 'YOUR_TEMPLATE_ID_5',  // ⬅️ 需要替换
  
  // 取消预约通知
  CANCEL_APPOINTMENT: 'YOUR_TEMPLATE_ID_6',  // ⬅️ 需要替换
}
```

### 如何获取模板ID

1. 登录微信公众平台：https://mp.weixin.qq.com/
2. 进入你的小程序管理后台
3. 左侧菜单：功能 > 订阅消息
4. 点击"选用"或"公共模板库"，搜索并添加以下模板：
   - 预约成功通知
   - 就诊提醒通知
   - 候补成功通知
   - 候补转预约通知
   - 改约成功通知
   - 取消预约通知
5. 添加成功后，可以看到每个模板的"模板ID"，复制到代码中

### 替换示例

假设你申请到的模板ID为：`abc123def456ghi789`，则修改为：

```javascript
APPOINTMENT_SUCCESS: 'abc123def456ghi789',
```

## 二、后端配置说明

后端开发人员需要配置：

1. **微信小程序AppID和AppSecret**
   - 位置：`config/wechat.py`
   - 获取路径：微信小程序后台 > 开发 > 开发管理 > 开发设置

2. **模板ID同步**
   - 前端配置的模板ID需要与后端配置保持一致

3. **服务器域名配置**
   - 必须是HTTPS
   - 需要在微信小程序后台配置服务器域名白名单

## 三、测试环境注意事项

- 在微信开发者工具中测试时，需要在"详情"中勾选"不校验合法域名"
- 真机调试时，必须配置合法的服务器域名
- 订阅消息授权弹窗只在真机上显示，开发者工具中看不到

## 四、常见问题

### Q1: 为什么调用 requestSubscribeMessage 没有弹出授权框？
A: 
- 必须在用户点击事件（如按钮tap）的第一层调用
- 不能放在异步回调中（如setTimeout、Promise.then）
- 必须在真机上测试（开发者工具不显示）

### Q2: 用户拒绝授权后怎么办？
A: 
- 业务流程继续进行，不阻断
- 后续用户可以在小程序设置中重新开启
- 可以在"我的"页面提供引导，让用户重新授权

### Q3: 模板ID从哪里来？
A: 
- 必须在微信小程序后台的"订阅消息"功能中申请
- 每个小程序的模板ID都是唯一的
- 申请后可能需要审核（一般很快通过）

### Q4: 消息发送不成功？
A: 
- 检查用户是否授权了对应的模板
- 检查后端access_token是否有效
- 检查后端模板ID配置是否正确
- 查看后端消息发送日志中的errcode和errmsg

## 五、改约功能集成（待补充）

改约功能的订阅消息集成方式与预约类似，需要在改约确认页面添加：

```javascript
// 在改约确认页面的提交按钮中
import { subscribeWithAuth, getTemplateIdsByScene } from '@/utils/subscribe'
import { saveSubscribeAuth } from '@/api/message'

const submitReschedule = async () => {
  // 步骤1: 请求订阅消息授权
  const subscribeResult = await subscribeWithAuth({
    templateIds: getTemplateIdsByScene('reschedule'),
    businessData: { appointmentId: xxx }
  })
  
  // 步骤2: 提交改约请求，携带订阅信息
  // ...
}
```

详细实现参考 `src/pages/home/appointment/confirm.vue`。

---

**配置完成后请通知后端开发人员同步配置！**
