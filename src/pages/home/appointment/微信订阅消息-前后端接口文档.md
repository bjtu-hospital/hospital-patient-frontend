# 微信订阅消息 - 前后端接口对接文档

## 文档说明

本文档仅定义前后端接口协议，数据库设计、具体实现由后端决定。

---

## 接口概述

订阅消息功能通过在现有接口中**添加可选字段**实现，无需新增独立接口。

涉及的接口：
1. `POST /patient/appointments` - 创建预约（需改造）
2. `POST /patient/waitlist` - 创建候补（需改造）
3. `PUT /patient/appointments/{id}/reschedule` - 改约（需改造）
4. `DELETE /patient/appointments/{id}` - 取消预约（需改造）

---

## 1. 创建预约接口（改造）

### 请求

**路径**: `POST /patient/appointments`

**请求头**:
```
Authorization: Bearer {token}
Content-Type: application/json
```

**请求体**:
```json
{
  // ========== 原有字段 ==========
  "scheduleId": 123,
  "hospitalId": 1,
  "departmentId": 5,
  "patientId": 10,
  "symptoms": "头痛",
  
  // ========== 新增字段（可选） ==========
  "wxCode": "071aBcDe1f23g4",
  "subscribeAuthResult": {
    "模板ID1": "accept",
    "模板ID2": "accept"
  },
  "subscribeScene": "appointment"
}
```

### 新增字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| wxCode | string | 否 | 前端通过 `wx.login()` 获取的临时code，5分钟有效，只能使用一次 |
| subscribeAuthResult | object | 否 | 用户订阅授权结果，key为模板ID，value为授权状态<br>- `accept`: 用户同意<br>- `reject`: 用户拒绝<br>- `ban`: 用户已禁用 |
| subscribeScene | string | 否 | 业务场景标识，固定值 `"appointment"` |

### 后端处理逻辑

```
1. 如果有 wxCode：
   - 调用微信接口换取 openid
   - 保存 user_id 和 openid 的绑定关系

2. 如果有 subscribeAuthResult：
   - 保存用户的订阅授权记录（供后续发送消息时检查）

3. 创建预约记录（原有逻辑）

4. 发送订阅消息：
   - 检查用户是否授权了"预约成功通知"模板
   - 如果授权，调用微信接口发送订阅消息
   - 记录发送日志
```

### 微信接口调用参考

**换取 openid**:
```http
GET https://api.weixin.qq.com/sns/jscode2session?appid={AppID}&secret={AppSecret}&js_code={wxCode}&grant_type=authorization_code
```

返回:
```json
{
  "openid": "用户openid",
  "session_key": "会话密钥"
}
```

**发送订阅消息**:
```http
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token={token}
```

请求体:
```json
{
  "touser": "用户openid",
  "template_id": "模板ID",
  "page": "pages/profile/appointments?id=123",
  "data": {
    "thing1": {"value": "张三"},
    "thing2": {"value": "内科"},
    "time3": {"value": "2023-12-18 上午"},
    "thing4": {"value": "北交大校医院"},
    "thing5": {"value": "请提前15分钟到院"}
  }
}
```

### 响应（无变化）

```json
{
  "id": 456,
  "orderNo": "AP20231216001",
  "appointmentDate": "2023-12-18",
  "appointmentTime": "上午 08:00-12:00",
  "queueNumber": 15,
  "payAmount": 10.0,
  "needPay": true,
  "status": "pending",
  "paymentStatus": "pending"
}
```

---

## 2. 创建候补接口（改造）

### 请求

**路径**: `POST /patient/waitlist`

**请求体**:
```json
{
  // ========== 原有字段 ==========
  "scheduleId": 123,
  "patientId": 10,
  
  // ========== 新增字段（可选） ==========
  "wxCode": "071aBcDe1f23g4",
  "subscribeAuthResult": {
    "模板ID3": "accept",
    "模板ID4": "accept"
  },
  "subscribeScene": "waitlist"
}
```

### 后端处理逻辑

与预约接口类似：
1. 换取并保存 openid
2. 保存订阅授权记录
3. 创建候补记录
4. 发送"候补成功通知"订阅消息

### 响应（无变化）

```json
{
  "id": 789,
  "scheduleId": 123,
  "queueNumber": 3,
  "status": "waiting",
  "createdAt": "2023-12-16T10:30:00"
}
```

---

## 3. 改约接口（改造）

### 请求

**路径**: `PUT /patient/appointments/{id}/reschedule`

**路径参数**:
- `id`: 预约ID

**请求体**:
```json
{
  // ========== 原有字段 ==========
  "scheduleId": 456,
  
  // ========== 新增字段（可选） ==========
  "wxCode": "071aBcDe1f23g4",
  "subscribeAuthResult": {
    "模板ID5": "accept",
    "模板ID2": "accept"
  },
  "subscribeScene": "reschedule"
}
```

### 新增字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| wxCode | string | 否 | 前端通过 `wx.login()` 获取的临时code |
| subscribeAuthResult | object | 否 | 用户订阅授权结果 |
| subscribeScene | string | 否 | 业务场景标识，固定值 `"reschedule"` |

### 后端处理逻辑
---

## 6. 前端调用示例

### 6.1 预约场景e：
   - 调用微信接口换取 openid
   - 保存 user_id 和 openid 的绑定关系

2. 如果有 subscribeAuthResult：
   - 保存用户的订阅授权记录

3. 修改预约记录（原有逻辑）
   - 更新为新的 scheduleId
   - 自动取消原预约

4. 发送订阅消息：
   - 检查用户是否授权了"改约成功通知"模板
   - 如果授权，发送改约成功通知
   - 记录发送日志
```

### 响应（无变化）

```json
{
  "id": 456,
  "orderNo": "AP20231216001",
  "appointmentDate": "2023-12-20",
  "appointmentTime": "下午 14:00-18:00",
  "queueNumber": 8,
  "status": "pending"
}
```

---

## 4. 取消预约接口（改造）

### 请求

**路径**: `DELETE /patient/appointments/{id}`

**路径参数**:
- `id`: 预约ID

**请求体**（新增）:
```json
{
  // ========== 新增字段（可选） ==========
  "wxCode": "071aBcDe1f23g4",
  "subscribeAuthResult": {
    "模板ID6": "accept"
  },
  "subscribeScene": "cancel"
}
```

**⚠️ 注意**: DELETE请求需要支持请求体，或者改为POST方式

### 新增字段说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| wxCode | string | 否 | 前端通过 `wx.login()` 获取的临时code |
| subscribeAuthResult | object | 否 | 用户订阅授权结果 |
| subscribeScene | string | 否 | 业务场景标识，固定值 `"cancel"` |

### 后端处理逻辑

```
1. 如果有 wxCode：
   - 调用微信接口换取 openid
   - 保存 user_id 和 openid 的绑定关系

2. 如果有 subscribeAuthResult：
   - 保存用户的订阅授权记录

3. 取消预约记录（原有逻辑）
   - 更新状态为 cancelled
   - 释放号源

4. 发送订阅消息：
   - 检查用户是否授权了"取消预约通知"模板
   - 如果授权，发送取消预约通知
   - 记录发送日志
```

### 响应（无变化）

```json
{
  "success": true,
  "refundAmount": 10.0
}
```

---

## 5. 订阅消息模板配置

前端在 `src/utils/subscribe.js` 中配置了以下业务场景对应的模板：

### 预约场景 (scene = "appointment")
- 模板ID1: 预约成功通知
- 模板ID2: 就诊提醒通知

### 候补场景 (scene = "waitlist")
- 模板ID3: 候补成功通知
- 模板ID4: 候补转预约通知

### 改约场景 (scene = "reschedule")
- 模板ID5: 改约成功通知
- 模板ID2: 就诊提醒通知

### 取消预约场景 (scene = "cancel")
- 模板ID6: 取消预约通知

**具体的模板ID由前端在微信小程序后台申请后提供给后端配置。**

---

## 4. 发送时机说明

| 消息类型 | 发送时机 | 触发条件 |
|---------|---------|---------|
| 预约成功通知 | 创建预约成功后立即发送 | 用户授权了该模板 |
| 候补成功通知 | 加入候补成功后立即发送 | 用户授权了该模板 |
| 候补转预约通知 | 候补转为预约时发送 | 用户授权了该模板 |
| 就诊提醒通知 | 就诊前一天晚上8点发送 | 用户授权了该模板（需定时任务） |
| 改约成功通知 | 改约成功后立即发送 | 用户授权了该模板 |
| 取消预约通知 | 取消预约成功后立即发送 | 用户授权了该模板 |

---

```javascript
// 在预约确认页面点击"提交"按钮
const submitAppointment = async () => {
  // 步骤1: 请求订阅授权（必须在按钮点击事件第一层调用）
  const subscribeResult = await subscribeWithAuth({
    templateIds: ['模板ID1', '模板ID2'],
    businessData: { patientId: 10 }
  })
  
  // subscribeResult 包含：
  // {
  //   code: "071aBcDe1f23g4",  // wx.login()获取的code
  //   authResult: {
  //     "模板ID1": "accept",
  //     "模板ID2": "reject"
  //   }
  // }
  
  // 步骤2: 调用后端接口创建预约
  const result = await createAppointment({
    scheduleId: 123,
    hospitalId: 1,
    departmentId: 5,
    patientId: 10,
    // 携带订阅消息信息
    wxCode: subscribeResult.code,
    subscribeAuthResult: subscribeResult.authResult,
    subscribeScene: 'appointment'
  })
}
```

### 6.2 改约场景

```javascript
// 在改约确认页面点击"确认改约"按钮
const submitReschedule = async () => {
  // 步骤1: 请求订阅授权
  const subscribeResult = await subscribeWithAuth({
    templateIds: ['模板ID5', '模板ID2'],
    businessData: { appointmentId: 123 }
  })
  
  // 步骤2: 调用后端接口改约
  const result = await rescheduleAppointment(appointmentId, {
    scheduleId: 456,
    // 携带订阅消息信息
    wxCode: subscribeResult.code,
    subscribeAuthResult: subscribeResult.authResult,
    subscribeScene: 'reschedule'
  })
}
```

### 6.3 取消预约场景

---

## 8. 测试要点elAppointment = async (appointmentId) => {
  // 步骤1: 弹出确认框
  uni.showModal({
    title: '取消预约',
    content: '确定要取消这个预约吗？',
    success: async (res) => {
      if (res.confirm) {
        // 步骤2: 请求订阅授权
        const subscribeResult = await subscribeWithAuth({
          templateIds: ['模板ID6'],
          businessData: { appointmentId }
        })
        
**联调测试**:
- [ ] 预约成功后立即收到消息（真机测试）
- [ ] 候补成功后立即收到消息（真机测试）
- [ ] 改约成功后立即收到消息（真机测试）
- [ ] 取消预约后立即收到消息（真机测试）
- [ ] 就诊前一天晚上8点收到提醒消息

---

## 9. 接口改造总结

### 9.1 前端已实现的功能
- ✅ 预约功能：已集成订阅消息
- ✅ 候补功能：已集成订阅消息
- ⚠️ 改约功能：需要补充订阅消息集成
- ⚠️ 取消预约：需要补充订阅消息集成

### 9.2 后端需要改造的接口

| 接口 | 需要添加的字段 | 需要发送的消息 | 优先级 |
|------|--------------|---------------|--------|
| POST /patient/appointments | wxCode, subscribeAuthResult, subscribeScene | 预约成功通知 | 高 |
| POST /patient/waitlist | wxCode, subscribeAuthResult, subscribeScene | 候补成功通知 | 高 |
| PUT /patient/appointments/{id}/reschedule | wxCode, subscribeAuthResult, subscribeScene | 改约成功通知 | 中 |
| DELETE /patient/appointments/{id} | wxCode, subscribeAuthResult, subscribeScene | 取消预约通知 | 中 |

### 9.3 后端需要实现的定时任务

| 任务 | 触发时间 | 发送的消息 | 优先级 |
|------|---------|-----------|--------|
| 就诊提醒 | 每天晚上8点 | 就诊提醒通知（明天有预约的用户） | 高 |
| 候补转预约 | 号源释放时 | 候补转预约通知 | 中 |

---

## 10. 附：微信小程序配置要求
  })
}
```

---

## 7. 重要说明

## 6. 重要说明

### 容错要求

1. **授权失败不影响业务**：即使用户拒绝授权或 wxCode 无效，预约/候补流程必须正常完成
2. **消息发送失败不影响业务**：发送订阅消息失败时只记录日志，不返回错误给前端
3. **可选字段处理**：如果前端未传 wxCode 或 subscribeAuthResult，后端应正常处理业务逻辑

### 安全要求

1. **AppSecret 绝对不能暴露给前端**
2. 所有微信 API 调用都必须在后端进行
3. openid 在日志中应脱敏显示

### 性能要求

1. 微信 access_token 需要缓存（有效期2小时）
2. 发送订阅消息建议使用异步任务队列，不阻塞主流程
3. 建议记录消息发送日志，便于排查问题

---

## 7. 测试要点

**前端需测试**:
- [ ] 用户同意授权后，业务流程正常
- [ ] 用户拒绝授权后，业务流程仍正常
- [ ] 多次授权不出错

**后端需测试**:
- [ ] 能成功换取 openid
- [ ] 能成功发送订阅消息
- [ ] 用户未授权时不发送消息
- [ ] wxCode 过期或无效时有容错处理

**联调测试**:
- [ ] 预约成功后立即收到消息（真机测试）
- [ ] 候补成功后立即收到消息（真机测试）
- [ ] 就诊前一天收到提醒消息

---

## 8. 附：微信小程序配置要求

后端配置完成后，需要在微信小程序后台配置：

1. **服务器域名白名单**（必须）:
   - 路径：开发 > 开发管理 > 开发设置 > 服务器域名
   - 添加：`https://你的域名` （必须是HTTPS）
   - ⚠️ 不支持 IP 地址和 HTTP 协议

2. **订阅消息模板**（必须）:
   - 路径：功能 > 订阅消息
   - 申请所需的消息模板
   - 获取模板ID并提供给后端配置

---

**前端负责人**: [你的名字]  
**后端负责人**: [后端名字]  
**文档版本**: v1.0  
**更新日期**: 2023-12-16
