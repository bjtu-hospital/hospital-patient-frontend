# æ”¯ä»˜æµç¨‹é›†æˆæŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•åœ¨é¢„çº¦æŒ‚å·æµç¨‹ä¸­é›†æˆæ”¯ä»˜åŠŸèƒ½ã€‚æ”¯ä»˜æµç¨‹å·²å®Œå…¨å®ç°ï¼ŒåŒ…æ‹¬æ”¯ä»˜è®¢å•åˆ›å»ºã€æ”¯ä»˜æ–¹å¼é€‰æ‹©ã€æ”¯ä»˜çŠ¶æ€ç®¡ç†ç­‰åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
é¢„çº¦æµç¨‹
  â†“
confirm.vue (ç¡®è®¤é¢„çº¦)
  â†“
payment.vue (æ”¯ä»˜é¡µé¢) â† æ–°å¢
  â†“
success.vue (é¢„çº¦æˆåŠŸ)
```

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ payment.js              # æ”¯ä»˜APIæ¥å£
â”œâ”€â”€ stores/
â”‚   â””â”€â”€ payment.js              # æ”¯ä»˜çŠ¶æ€ç®¡ç†
â”œâ”€â”€ pages/home/appointment/
â”‚   â”œâ”€â”€ confirm.vue             # å·²æ›´æ–°ï¼šé›†æˆæ”¯ä»˜
â”‚   â”œâ”€â”€ payment.vue             # æ–°å¢ï¼šæ”¯ä»˜é¡µé¢
â”‚   â””â”€â”€ success.vue             # å·²æ›´æ–°ï¼šæ”¯æŒæ”¯ä»˜åæµç¨‹
â”œâ”€â”€ constants/
â”‚   â””â”€â”€ index.js                # å·²æ›´æ–°ï¼šæ”¯ä»˜å¸¸é‡
â””â”€â”€ pages.json                  # å·²æ›´æ–°ï¼šæ”¯ä»˜è·¯ç”±
```

## ğŸ”„ æ”¯ä»˜æµç¨‹è¯¦è§£

### 1. é¢„çº¦ç¡®è®¤é˜¶æ®µ (confirm.vue)

**æµç¨‹**ï¼š
1. ç”¨æˆ·é€‰æ‹©å°±è¯Šäºº
2. ç¡®è®¤é¢„çº¦ä¿¡æ¯ï¼ˆåŒ»é™¢ã€ç§‘å®¤ã€åŒ»ç”Ÿã€æ—¶é—´ã€ä»·æ ¼ï¼‰
3. ç‚¹å‡»"æäº¤"æŒ‰é’®

**ä»£ç é€»è¾‘**ï¼š
```javascript
// æäº¤é¢„çº¦æ—¶çš„æ–°é€»è¾‘
const submitAppointment = async () => {
  // 1. åˆ›å»ºé¢„çº¦
  const result = await createAppointment(appointmentData)
  
  // 2. ä¿å­˜é¢„çº¦è®°å½•åˆ°æœ¬åœ°
  const appointmentRecord = {
    ...result,
    paymentStatus: 'pending'  // æ”¯ä»˜çŠ¶æ€ï¼šå¾…æ”¯ä»˜
  }
  uni.setStorageSync('myAppointments', [...appointments, appointmentRecord])
  
  // 3. åˆ›å»ºæ”¯ä»˜è®¢å•
  const paymentOrder = await createPaymentOrder({
    appointmentId: result.id,
    amount: appointmentInfo.price,
    paymentMethod: 'wechat'
  })
  
  // 4. ä¿å­˜æ”¯ä»˜è®¢å•åˆ° Store
  paymentStore.createOrder(paymentOrder)
  
  // 5. è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
  uni.navigateTo({ url: '/pages/home/appointment/payment' })
}
```

### 2. æ”¯ä»˜é˜¶æ®µ (payment.vue)

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºè®¢å•ä¿¡æ¯å’Œé‡‘é¢
- é€‰æ‹©æ”¯ä»˜æ–¹å¼ï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ã€é“¶è¡Œå¡ï¼‰
- 30åˆ†é’Ÿå€’è®¡æ—¶
- æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ

**æ”¯ä»˜æ–¹å¼**ï¼š
```javascript
const paymentMethods = [
  { id: 'wechat', name: 'å¾®ä¿¡æ”¯ä»˜', ... },
  { id: 'alipay', name: 'æ”¯ä»˜å®', ... },
  { id: 'bank', name: 'é“¶è¡Œå¡', ... }
]
```

**æ”¯ä»˜æµç¨‹**ï¼š
```javascript
const handlePayment = async () => {
  try {
    // 1. è°ƒç”¨æ”¯ä»˜æ¥å£
    const result = await mockPayment(orderId)
    
    // 2. æ›´æ–°æ”¯ä»˜è®¢å•çŠ¶æ€ä¸º"å·²æ”¯ä»˜"
    paymentStore.updateOrderStatus('paid', {
      transactionId: result.transactionId,
      paidAt: new Date().toISOString()
    })
    
    // 3. æ˜¾ç¤ºæ”¯ä»˜æˆåŠŸæç¤º
    // 4. è·³è½¬åˆ°æˆ‘çš„é¢„çº¦
  } catch (error) {
    // æ”¯ä»˜å¤±è´¥å¤„ç†
  }
}
```

**å€’è®¡æ—¶é€»è¾‘**ï¼š
- è®¢å•åˆ›å»ºåï¼Œ30åˆ†é’Ÿå†…å¿…é¡»å®Œæˆæ”¯ä»˜
- å€’è®¡æ—¶ç»“æŸåï¼Œè®¢å•è‡ªåŠ¨å–æ¶ˆ
- ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨å–æ¶ˆæ”¯ä»˜

### 3. æ”¯ä»˜æˆåŠŸå (success.vue)

**çŠ¶æ€æ›´æ–°**ï¼š
```javascript
// é¢„çº¦çŠ¶æ€æµè½¬
pending (å¾…æ”¯ä»˜) â†’ paid (å·²æ”¯ä»˜) â†’ pending (å¾…å°±è¯Š)
```

**åç»­æ“ä½œ**ï¼š
- è·³è½¬åˆ°"æˆ‘çš„é¢„çº¦"é¡µé¢
- æ˜¾ç¤ºé¢„çº¦è¯¦æƒ…
- æ”¯æŒå–æ¶ˆ/æ”¹çº¦æ“ä½œ

## ğŸ”Œ API æ¥å£

### æ”¯ä»˜ç›¸å…³æ¥å£ (src/api/payment.js)

#### 1. åˆ›å»ºæ”¯ä»˜è®¢å•
```javascript
createPaymentOrder(data)
// å‚æ•°: { appointmentId, amount, paymentMethod }
// è¿”å›: { orderId, amount, status, expiryTime, ... }
```

#### 2. è·å–æ”¯ä»˜äºŒç»´ç 
```javascript
getPaymentQRCode(orderId)
// å‚æ•°: orderId
// è¿”å›: { qrCodeUrl, orderId }
```

#### 3. æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
```javascript
queryPaymentStatus(orderId)
// å‚æ•°: orderId
// è¿”å›: { orderId, status, amount, transactionId, ... }
```

#### 4. æ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆMockå¼€å‘ç”¨ï¼‰
```javascript
mockPayment(orderId)
// å‚æ•°: orderId
// è¿”å›: { success: true, transactionId, ... }
```

#### 5. å–æ¶ˆæ”¯ä»˜è®¢å•
```javascript
cancelPaymentOrder(orderId)
// å‚æ•°: orderId
// è¿”å›: true/false
```

#### 6. è·å–æ”¯ä»˜æ–¹å¼åˆ—è¡¨
```javascript
getPaymentMethods()
// è¿”å›: [{ id, name, icon, description }, ...]
```

## ğŸ’¾ çŠ¶æ€ç®¡ç†

### Payment Store (src/stores/payment.js)

**State**ï¼š
```javascript
{
  currentOrder: null,           // å½“å‰æ”¯ä»˜è®¢å•
  paymentMethod: 'wechat',      // é€‰æ‹©çš„æ”¯ä»˜æ–¹å¼
  paymentHistory: [],           // æ”¯ä»˜å†å²
  isProcessing: false,          // æ˜¯å¦å¤„ç†ä¸­
  paymentError: null            // æ”¯ä»˜é”™è¯¯ä¿¡æ¯
}
```

**Getters**ï¼š
```javascript
isPaymentPending    // æ˜¯å¦å¾…æ”¯ä»˜
isPaymentCompleted  // æ˜¯å¦å·²æ”¯ä»˜
isPaymentFailed     // æ˜¯å¦æ”¯ä»˜å¤±è´¥
isPaymentExpired    // æ˜¯å¦å·²è¿‡æœŸ
```

**Actions**ï¼š
```javascript
createOrder(order)              // åˆ›å»ºè®¢å•
updateOrderStatus(status, ...)  // æ›´æ–°è®¢å•çŠ¶æ€
setPaymentMethod(method)        // è®¾ç½®æ”¯ä»˜æ–¹å¼
setProcessing(bool)             // è®¾ç½®å¤„ç†çŠ¶æ€
setPaymentError(error)          // è®¾ç½®é”™è¯¯ä¿¡æ¯
addToHistory(payment)           // æ·»åŠ åˆ°å†å²
clearCurrentOrder()             // æ¸…é™¤å½“å‰è®¢å•
restoreOrder()                  // æ¢å¤è®¢å•ï¼ˆä»æœ¬åœ°å­˜å‚¨ï¼‰
```

## ğŸ“Š æ”¯ä»˜çŠ¶æ€æµè½¬

```
pending (å¾…æ”¯ä»˜)
  â†“
[ç”¨æˆ·é€‰æ‹©æ”¯ä»˜æ–¹å¼]
  â†“
[ç”¨æˆ·ç¡®è®¤æ”¯ä»˜]
  â†“
paid (å·²æ”¯ä»˜) âœ“
  â†“
[è·³è½¬åˆ°æˆ‘çš„é¢„çº¦]

æˆ–

pending (å¾…æ”¯ä»˜)
  â†“
[å€’è®¡æ—¶ç»“æŸ]
  â†“
expired (å·²è¿‡æœŸ)
  â†“
[è®¢å•è‡ªåŠ¨å–æ¶ˆ]

æˆ–

pending (å¾…æ”¯ä»˜)
  â†“
[æ”¯ä»˜å¤±è´¥]
  â†“
failed (æ”¯ä»˜å¤±è´¥)
  â†“
[ç”¨æˆ·å¯é‡è¯•æˆ–å–æ¶ˆ]
```

## ğŸ” å®‰å…¨è€ƒè™‘

### ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹

1. **æ”¯ä»˜å‡­è¯éªŒè¯**
   - æ”¯ä»˜æˆåŠŸåï¼Œå¿…é¡»éªŒè¯æ”¯ä»˜å‡­è¯
   - è°ƒç”¨ `verifyPayment()` æ¥å£éªŒè¯äº¤æ˜“å·

2. **è®¢å•è¶…æ—¶å¤„ç†**
   - 30åˆ†é’Ÿå†…æœªæ”¯ä»˜ï¼Œè®¢å•è‡ªåŠ¨å–æ¶ˆ
   - å¯é…ç½®è¶…æ—¶æ—¶é—´ï¼ˆè§å¸¸é‡ï¼‰

3. **é‡å¤æ”¯ä»˜é˜²æŠ¤**
   - åŒä¸€è®¢å•åªèƒ½æ”¯ä»˜ä¸€æ¬¡
   - æ”¯ä»˜æˆåŠŸåï¼Œç«‹å³æ›´æ–°è®¢å•çŠ¶æ€

4. **é‡‘é¢éªŒè¯**
   - æ”¯ä»˜å‰éªŒè¯é‡‘é¢æ˜¯å¦æ­£ç¡®
   - é˜²æ­¢é‡‘é¢ç¯¡æ”¹

## ğŸ§ª Mock å¼€å‘æ¨¡å¼

### å¯ç”¨ Mock æ•°æ®

åœ¨ `src/api/payment.js` ä¸­ï¼š
```javascript
const USE_MOCK = true  // å¼€å‘é˜¶æ®µä½¿ç”¨ Mock
```

### Mock æ”¯ä»˜æµç¨‹

1. **åˆ›å»ºè®¢å•**ï¼šè‡ªåŠ¨ç”Ÿæˆè®¢å•IDå’Œè¿‡æœŸæ—¶é—´
2. **æŸ¥è¯¢çŠ¶æ€**ï¼šè¿”å›å½“å‰è®¢å•çŠ¶æ€
3. **æ¨¡æ‹Ÿæ”¯ä»˜**ï¼šè°ƒç”¨ `mockPayment()` ç«‹å³å®Œæˆæ”¯ä»˜

### æµ‹è¯•æ”¯ä»˜æµç¨‹

```javascript
// 1. åˆ›å»ºè®¢å•
const order = await createPaymentOrder({
  appointmentId: 'apt_123',
  amount: 50,
  paymentMethod: 'wechat'
})

// 2. æ¨¡æ‹Ÿæ”¯ä»˜
const result = await mockPayment(order.orderId)
// result: { success: true, transactionId: '...', ... }

// 3. æŸ¥è¯¢çŠ¶æ€
const status = await queryPaymentStatus(order.orderId)
// status: { status: 'paid', ... }
```

## ğŸ”„ ä¸åç«¯é›†æˆ

### åˆ‡æ¢åˆ°çœŸå®API

1. **ä¿®æ”¹ USE_MOCK æ ‡å¿—**
   ```javascript
   const USE_MOCK = false  // ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çœŸå®API
   ```

2. **åç«¯æ¥å£è¦æ±‚**
   - `POST /patient/payments/create` - åˆ›å»ºæ”¯ä»˜è®¢å•
   - `GET /patient/payments/{orderId}/qrcode` - è·å–äºŒç»´ç 
   - `GET /patient/payments/{orderId}/status` - æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
   - `POST /patient/payments/verify` - éªŒè¯æ”¯ä»˜å‡­è¯
   - `GET /patient/payments/methods` - è·å–æ”¯ä»˜æ–¹å¼

3. **å“åº”æ ¼å¼**
   ```json
   {
     "code": 0,
     "message": "success",
     "data": {
       "orderId": "order_123",
       "status": "paid",
       "transactionId": "txn_123",
       ...
     }
   }
   ```

## ğŸ“± ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### æ”¯ä»˜é¡µé¢ç‰¹æ€§

1. **æ¸…æ™°çš„è®¢å•ä¿¡æ¯**
   - æ˜¾ç¤ºåŒ»é™¢ã€ç§‘å®¤ã€åŒ»ç”Ÿã€æ—¶é—´
   - æ˜¾ç¤ºé‡‘é¢å’Œè®¢å•å·

2. **å¤šç§æ”¯ä»˜æ–¹å¼**
   - å¾®ä¿¡æ”¯ä»˜ï¼ˆæ‰«ç ï¼‰
   - æ”¯ä»˜å®ï¼ˆæ‰«ç ï¼‰
   - é“¶è¡Œå¡ï¼ˆè¾“å…¥å¡å·ï¼‰

3. **å€’è®¡æ—¶æç¤º**
   - å®æ—¶æ˜¾ç¤ºå‰©ä½™æ”¯ä»˜æ—¶é—´
   - é˜²æ­¢ç”¨æˆ·é—å¿˜

4. **é”™è¯¯æç¤º**
   - æ”¯ä»˜å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
   - æ”¯æŒé‡è¯•

5. **åº•éƒ¨æ“ä½œæŒ‰é’®**
   - "ç¡®è®¤æ”¯ä»˜"æŒ‰é’®
   - "å–æ¶ˆæ”¯ä»˜"æŒ‰é’®

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æ”¯ä»˜è¶…æ—¶åæ€ä¹ˆåŠï¼Ÿ
A: è®¢å•è‡ªåŠ¨å–æ¶ˆï¼Œç”¨æˆ·éœ€è¦é‡æ–°é¢„çº¦ã€‚

### Q2: æ”¯ä»˜å¤±è´¥å¯ä»¥é‡è¯•å—ï¼Ÿ
A: å¯ä»¥ï¼Œç”¨æˆ·å¯ä»¥ç‚¹å‡»"ç¡®è®¤æ”¯ä»˜"é‡è¯•ï¼Œæœ€å¤šé‡è¯•3æ¬¡ï¼ˆè§å¸¸é‡ï¼‰ã€‚

### Q3: æ”¯ä»˜æˆåŠŸåé¢„çº¦æ˜¯å¦ç«‹å³ç”Ÿæ•ˆï¼Ÿ
A: æ˜¯çš„ï¼Œæ”¯ä»˜æˆåŠŸåé¢„çº¦ç«‹å³ç”Ÿæ•ˆï¼Œç”¨æˆ·å¯ä»¥åœ¨"æˆ‘çš„é¢„çº¦"ä¸­æŸ¥çœ‹ã€‚

### Q4: æ”¯ä»˜ä¿¡æ¯æ˜¯å¦å®‰å…¨ï¼Ÿ
A: æ”¯ä»˜ä¿¡æ¯é€šè¿‡åŠ å¯†ä¼ è¾“ï¼Œä¸å­˜å‚¨æ•æ„Ÿä¿¡æ¯ã€‚

## ğŸ“ æ€»ç»“

æ”¯ä»˜æµç¨‹å·²å®Œå…¨é›†æˆåˆ°é¢„çº¦ç³»ç»Ÿä¸­ï¼ŒåŒ…æ‹¬ï¼š

âœ… æ”¯ä»˜è®¢å•åˆ›å»ºå’Œç®¡ç†
âœ… å¤šç§æ”¯ä»˜æ–¹å¼æ”¯æŒ
âœ… æ”¯ä»˜è¶…æ—¶è‡ªåŠ¨å–æ¶ˆ
âœ… æ”¯ä»˜çŠ¶æ€å®æ—¶æŸ¥è¯¢
âœ… Mock å¼€å‘æ¨¡å¼æ”¯æŒ
âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†

ä¸‹ä¸€æ­¥å¯ä»¥ï¼š
1. ä¸çœŸå®æ”¯ä»˜ç½‘å…³é›†æˆï¼ˆå¾®ä¿¡ã€æ”¯ä»˜å®ï¼‰
2. æ·»åŠ æ”¯ä»˜å†å²æŸ¥è¯¢åŠŸèƒ½
3. æ”¯æŒé€€æ¬¾æµç¨‹
4. æ·»åŠ å‘ç¥¨åŠŸèƒ½
